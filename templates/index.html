<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PILZ Report Checker - Modern</title>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
    <link href="/static/style.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="/static/logo.png" />

<body class="dark">
    <div class="container">
        <header class="site-header animate__animated animate__fadeInDown">
            <div class="brand">
                <img src="/static/logo.png" alt="PILZ" />
                <div>
                      <h1>PILZ Report Checker</h1>
                    <div class="tagline">Geli≈ümi≈ü Rapor Analiz Sistemi</div>
                </div>
            </div>
            <div class="header-nav">
                <button id="analysisBtn" class="nav-btn selected" type="button">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <span>Rapor Analizi</span>
                </button>
                <button id="evaluationBtn" class="nav-btn" type="button">
                    <i class="fa-solid fa-chart-bar"></i>
                    <span>Rapor Deƒüerlendirme</span>
                </button>
                <button id="ticketsBtn" class="nav-btn" type="button">
                    <i class="fa-solid fa-ticket"></i>
                    <span>Tickets</span>
                </button>
                <button id="themeToggle" class="theme-toggle" type="button" aria-label="Tema Deƒüi≈ütir">
                    <i class="fa-solid fa-moon"></i>
                    <span>Tema</span>
                </button>
            </div>
        </header>

        <main class="grid animate__animated animate__fadeInUp">
            <!-- Analysis View (Default) -->
            <div id="analysisView" class="view-content">
                <section class="panel" style="grid-column:1/-1;">
                    <form id="analysisForm" enctype="multipart/form-data" novalidate>
                        <div id="uploadSection" class="upload-zone">
                            <i class="fa-solid fa-cloud-arrow-up"></i>
                            <h3>Dosyanƒ±zƒ± Y√ºkleyin</h3>
                            <p class="meta">S√ºr√ºkleyip bƒ±rak veya tƒ±kla</p>
                            <p class="meta">PDF, JPG, JPEG, PNG (Max 32MB)</p>
                            <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png" hidden />
                            <button type="button" class="btn-primary" onclick="document.getElementById('fileInput').click()"><i class="fa-solid fa-plus"></i> Dosya Se√ß</button>
                        </div>

                        <div class="file-info" id="fileInfo">
                            <span id="fileName"></span>
                            <span id="fileSize"></span>
                        </div>

                            <div class="select-wrap" style="margin-top:1.3rem;">
                                <select id="documentType" name="document_type" required>
                                    <option value="">-- Rapor t√ºr√ºn√º se√ßiniz --</option>
                                </select>
                                <i class="fa-solid fa-angle-down"></i>
                            </div>

                            <div class="actions" style="display: flex; gap: 0.8rem;">
                                <button id="analyzeBtn" class="btn-primary" type="submit" disabled>
                                    <i class="fa-solid fa-magnifying-glass"></i> Analiz Et
                                </button>
                                <button type="button" class="btn-add-doc-type" onclick="openAddDocTypeModal()" style="margin: 0;">
                                    <i class="fa-solid fa-plus-circle"></i> D√∂k√ºman T√ºr√º Ekle
                                </button>
                                <button type="button" class="btn-manage-types" onclick="openManageDynamicTypesModal()" style="margin: 0;">
                                    <i class="fa-solid fa-plus-circle"></i> Yeni T√ºrleri Y√∂net
                                </button>
                            </div>
                    </form>
                    <div id="loading" class="loading">
                        <div class="spinner"></div>
                        <h3 style="font-size:.9rem; letter-spacing:.5px; font-weight:500;">Analiz Ediliyor...</h3>
                        <p style="font-size:.65rem; letter-spacing:.75px; color:var(--text-dim);">L√ºtfen bekleyin</p>
                    </div>
                    <div id="errorMessage" class="error"></div>
                </section>

                <section id="resultsSection" class="results" style="grid-column:1/-1;">
                    <div class="result-head">
                        <h2><i class="fa-solid fa-chart-line"></i> Analiz Sonu√ßlarƒ±</h2>
                        <button id="toggleJsonBtn" class="toggle-json" onclick="toggleJsonView()">JSON</button>
                    </div>
                    <div class="result-body">
                        <div id="visualResults"></div>
                        <pre id="resultsJson" class="json-view"></pre>
                         <div id="issueReportSection" class="issue-report-section" style="display: none;">
                            <div class="issue-report-header">
                                <i class="fa-solid fa-comment-dots"></i>
                                <h3>Yorum</h3>
                            </div>
                            <input type="text" id="inspectorName" class="inspector-name-input" placeholder="ƒ∞sminiz..." />
                            <textarea id="inspectorComment" class="inspector-comment" placeholder="Analiz ile ilgili g√∂r√º≈ü, eksiklik veya sorunlarƒ± detaylƒ± olarak yazƒ±nƒ±z..."></textarea>
                            <div class="issue-report-actions">
                                <button type="button" class="btn-report-issue" onclick="reportIssue()">
                                    <i class="fa-solid fa-flag"></i> Sorun Bildir
                                </button>
                            </div>
                        </div>
                        <div class="result-actions">
                            <button type="button" class="btn-secondary" onclick="showEvaluationSection()"><i class="fa-solid fa-pen-to-square"></i> Deƒüerlendir</button>
                            <button type="button" class="btn-secondary" onclick="resetForm()"><i class="fa-solid fa-plus"></i> Yeni Analiz</button>
                        </div>
                    </div>
                </section>

                <section id="evaluationSection" class="evaluation panel" style="grid-column:1/-1;">
                    <div class="eval-head">
                        <i class="fa-solid fa-pen"></i>
                        <h2 style="font-size:1rem; font-weight:600; letter-spacing:.5px;">Analiz Deƒüerlendirmesi</h2>
                    </div>
                    <div class="eval-grid">
                        <div><input id="evalDocumentName" readonly placeholder="Belge Adƒ±" /></div>
                        <div><input id="evalDocumentSize" readonly placeholder="Dosya Boyutu" /></div>
                            <div><input id="evalDocumentType" readonly placeholder="Rapor Tipi" /></div>
                        <div><input id="evalAnalysisDate" readonly placeholder="Analiz Tarihi" /></div>
                    </div>
                    <div class="eval-notes">
                        <textarea id="evaluationNotes" placeholder="Notlar...&#10;√ñrnek: Sonu√ßlar doƒüru mu? Eksikler? √ñneriler..."></textarea>
                    </div>
                    <div class="eval-actions">
                        <button class="btn-outline" type="button" onclick="hideEvaluationSection()"><i class="fa-solid fa-xmark"></i> ƒ∞ptal</button>
                        <button class="btn-save" type="button" onclick="saveEvaluation()"><i class="fa-solid fa-floppy-disk"></i> Kaydet</button>
                    </div>
                </section>
            </div>

            <!-- Evaluation View (Hidden by default) -->
            <div id="evaluationView" class="view-content" style="display: none;">
                <section class="panel" style="grid-column:1/-1;">
                    <div class="eval-header">
                        <h2><i class="fa-solid fa-chart-bar"></i> Analiz Tarihi:</h2>
                    </div>
                    <div id="evaluationGrid" class="evaluation-grid">
                        <!-- Evaluation widgets will be loaded here -->
                    </div>
                </section>
            </div>
            <!-- Tickets View (Hidden by default) -->
            <div id="ticketsView" class="view-content" style="display: none;">
                <section class="panel" style="grid-column:1/-1;">
                    <div class="tickets-header">
                        <div class="search-container">
                            <div class="filter-group">
                                <label class="filter-label">Durum</label>
                                <select id="statusFilter" class="filter-select">
                                    <option value="">Hepsi</option>
                                    <option value="ƒ∞nceleniyor">ƒ∞nceleniyor</option>
                                    <option value="Onaylanmadƒ±">Onaylanmadƒ±</option>
                                    <option value="Sorunlu">Sorunlu</option>
                                    <option value="Kapalƒ±">Kapalƒ±</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Ba≈ülangƒ±√ß Tarihi</label>
                                <input type="date" id="dateFrom" class="date-input" />
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Biti≈ü Tarihi</label>
                                <input type="date" id="dateTo" class="date-input" />
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Sorumlu</label>
                                <input type="text" id="responsibleFilter" class="filter-input" placeholder="Sorumlu ara..." />
                            </div>
                            <button type="button" class="btn-search" onclick="searchTickets()">
                                <i class="fa-solid fa-search"></i> Arama
                            </button>
                        </div>
                    </div>
                    <div id="ticketsContent" class="tickets-content">
                        <div class="placeholder-content">
                            <i class="fa-solid fa-ticket" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
                            <h3>Hen√ºz ticket bulunmuyor</h3>
                            <p style="color: var(--text-dim);">Buraya tickets i√ßeriƒüi eklenecek</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
                    <div class="result-actions">
                        <button type="button" class="btn-secondary" onclick="showEvaluationSection()"><i class="fa-solid fa-pen-to-square"></i> Deƒüerlendir</button>
                        <button type="button" class="btn-secondary" onclick="resetForm()"><i class="fa-solid fa-plus"></i> Yeni Analiz</button>
                    </div>
                </div>
            </section>

            <section id="evaluationSection" class="evaluation panel" style="grid-column:1/-1;">
                <div class="eval-head">
                    <i class="fa-solid fa-pen"></i>
                    <h2 style="font-size:1rem; font-weight:600; letter-spacing:.5px;">Analiz Deƒüerlendirmesi</h2>
                </div>
                <div class="eval-grid">
                    <div><input id="evalDocumentName" readonly placeholder="Belge Adƒ±" /></div>
                    <div><input id="evalDocumentSize" readonly placeholder="Dosya Boyutu" /></div>
                        <div><input id="evalDocumentType" readonly placeholder="Rapor Tipi" /></div>
                    <div><input id="evalAnalysisDate" readonly placeholder="Analiz Tarihi" /></div>
                </div>
                <div class="eval-notes">
                    <textarea id="evaluationNotes" placeholder="Notlar...&#10;√ñrnek: Sonu√ßlar doƒüru mu? Eksikler? √ñneriler..."></textarea>
                </div>
                <div class="eval-actions">
                    <button class="btn-outline" type="button" onclick="hideEvaluationSection()"><i class="fa-solid fa-xmark"></i> ƒ∞ptal</button>
                    <button class="btn-save" type="button" onclick="saveEvaluation()"><i class="fa-solid fa-floppy-disk"></i> Kaydet</button>
                </div>
            </section>
        </main>
    </div>
    <footer>¬© 2025 PILZ Report Checker ‚Ä¢ <a href="/api/services" target="_blank">Servisler</a></footer>

    <script>

        // =====================================================
        // TOAST NOTIFICATION SYSTEM
        // =====================================================

        const AUTHORIZED_USERS = ["Sava≈ü", "Kayra", "Can", "Utku"];

        // Toast container olu≈ütur
        function initToastContainer() {
            if (!document.querySelector('.toast-container')) {
                const container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
        }

        // Toast g√∂ster
        function showToast(message, type = 'info', duration = 3000) {
            initToastContainer();
            
            const container = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            // Icon se√ß
            let icon = 'ü§ñ';
            if (type === 'success') icon = '‚úÖ';
            else if (type === 'error') icon = '‚ùå';
            else if (type === 'info') icon = '‚ÑπÔ∏è';
            
            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="closeToast(this)">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Auto close (duration = 0 ise sonsuz)
            if (duration > 0) {
                setTimeout(() => {
                    closeToast(toast.querySelector('.toast-close'));
                }, duration);
            }
            
            return toast;
        }

        // Toast kapat
        function closeToast(button) {
            const toast = button.closest('.toast');
            if (toast) {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }
        }

        // T√ºm toast'larƒ± kapat
        function closeAllToasts() {
            document.querySelectorAll('.toast').forEach(toast => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            });
        }

        let selectedFile = null;
        let currentTicketId = null;      // üëà YENƒ∞ EKLE
        let pollingInterval = null;

        // DOM Elements
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const documentType = document.getElementById('documentType');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const analysisForm = document.getElementById('analysisForm');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const resultsSection = document.getElementById('resultsSection');
        const resultsJson = document.getElementById('resultsJson');
        const analysisInfo = document.getElementById('analysisInfo');

        // File input change event
        fileInput.addEventListener('change', handleFileSelect);

        // Drag and drop events
        uploadSection.addEventListener('dragover', handleDragOver);
        uploadSection.addEventListener('dragleave', handleDragLeave);
        uploadSection.addEventListener('drop', handleDrop);

        // Document type change event
        documentType.addEventListener('change', checkFormValidity);
        documentType.addEventListener('change', hideError);

        // Form submit event
        analysisForm.addEventListener('submit', handleFormSubmit);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            uploadSection.classList.add('dragover');
        }

        function handleDragLeave() {
            uploadSection.classList.remove('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function processFile(file) {
            // Check file type
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            if (!allowedTypes.includes(file.type)) {
                showError('Desteklenmeyen dosya t√ºr√º. L√ºtfen PDF, JPG, JPEG veya PNG dosyasƒ± se√ßin.');
                return;
            }

            // Check file size (32MB = 32 * 1024 * 1024 bytes)
            const maxSize = 32 * 1024 * 1024;
            if (file.size > maxSize) {
                showError('Dosya boyutu √ßok b√ºy√ºk. Maksimum 32MB dosya y√ºkleyebilirsiniz.');
                return;
            }

            selectedFile = file;
            
            // Show file info
            fileName.textContent = `üìÑ ${file.name}`;
            fileSize.textContent = `üíæ ${formatFileSize(file.size)}`;
            fileInfo.classList.add('show');
            
            // Update file input
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            
            checkFormValidity();
            hideError();  // Yeni dosya se√ßildiƒüinde hata mesajƒ±nƒ± gizle
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function checkFormValidity() {
            const isValid = selectedFile && documentType.value;
            analyzeBtn.disabled = !isValid;
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            
            if (!selectedFile || !documentType.value) {
                showError('L√ºtfen dosya se√ßin ve rapor t√ºr√ºn√º belirtin.');
                return;
            }

            showLoading();
            hideError();

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('document_type', documentType.value);

            try {
                // ASYNC: Hemen response d√∂necek
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();

                if (response.ok && result.success) {
                    // Ticket ID'yi sakla
                    currentTicketId = result.ticket_id;

                    hideLoading();
                    
                    showInfo(`‚è≥ Analiz ba≈ülatƒ±ldƒ± (Ticket: ${result.ticket_no}). Sonu√ßlar hazƒ±rlanƒ±yor...`);
                    
                    // POLLING BA≈ûLAT (5 saniyede bir kontrol et)
                    startPolling(result.ticket_id);
                    
                } else {
                    showError(result.message || 'Analiz ba≈ülatƒ±lamadƒ±.');
                    hideLoading();
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Baƒülantƒ± hatasƒ±. L√ºtfen tekrar deneyin.');
                hideLoading();
            }
        }

        function startPolling(ticketId) {
            console.log('üîÑ Polling ba≈üladƒ±:', ticketId);
            
            // Eski polling varsa durdur
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            // ƒ∞lk kontrol√º hemen yap
            checkTicketStatus(ticketId);
            
            // 5 saniyede bir kontrol et
            pollingInterval = setInterval(() => {
                checkTicketStatus(ticketId);
            }, 5000);
        }

        async function checkTicketStatus(ticketId) {
            try {
                // Filtreyle ticket'ƒ± √ßek
                const response = await fetch(`/api/tickets?ticket_id=${ticketId}`);
                const tickets = await response.json();
                
                if (!tickets || tickets.length === 0) {
                    console.log('Ticket hen√ºz bulunamadƒ±, bekleniyor...');
                    return;
                }
                
                const ticket = tickets[0];
                console.log('üìä Ticket status:', ticket.status);
                
                // Status kontrol√º
                if (ticket.status === 'ƒ∞≈üleniyor') {
                    // Hala i≈üleniyor, bekle
                    console.log('‚è≥ Analiz devam ediyor...');
                    return;
                }
                
                // Analiz tamamlandƒ± (Kapalƒ±, Hatalƒ±, vb.)
                console.log('‚úÖ Analiz tamamlandƒ±!');
                stopPolling();
                hideLoading();
                
                if (ticket.status === 'Hatalƒ±') {
                    // Hata durumu
                    const errorMsg = ticket.analysis_result?.error || 'Analiz sƒ±rasƒ±nda bir hata olu≈ütu.';
                    showError(errorMsg);
                } else {
                    // Ba≈üarƒ±lƒ± - Sonu√ßlarƒ± g√∂ster
                    displayAnalysisResults(ticket);
                }
                
            } catch (error) {
                console.error('Polling hatasƒ±:', error);
                // Hata olsa bile polling devam etsin (network sorunlarƒ± i√ßin)
            }
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.log('‚èπÔ∏è Polling durduruldu');
            }
        }

        function displayAnalysisResults(ticket) {
            // Mevcut showResults() fonksiyonunu kullan
            // Ama √∂nce data formatƒ±nƒ± d√ºzenle
            
            const analysisData = ticket.analysis_result;
            
            // currentAnalysisData'yƒ± g√ºncelle (deƒüerlendirme i√ßin)
            currentAnalysisData = {
                filename: ticket.document_name,
                analysis_id: ticket.ticket_id,
                file_type: ticket.document_type,
                analysis_date: ticket.opening_date,
                overall_score: analysisData.overall_score || {},
                category_scores: analysisData.category_scores || {},
                extracted_values: analysisData.extracted_values || {},
                recommendations: analysisData.recommendations || [],
                summary: analysisData.summary || ''
            };
            
            // Mevcut showResults() fonksiyonuna uygun format
            const result = {
                success: true,
                data: currentAnalysisData
            };
            
            showResults(result);
            
            // Issue report section g√∂ster
            document.getElementById('issueReportSection').style.display = 'block';
        }

        function showLoading() {
            loading.classList.add('show');
            analyzeBtn.disabled = true;
        }

        function hideLoading() {
            loading.classList.remove('show');
            checkFormValidity();
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            // Otomatik gizleme kaldƒ±rƒ±ldƒ± - yeni rapor y√ºklenene kadar kalacak
        }

        function showInfo(message) {
            errorMessage.innerHTML = `
                <i class="fa-solid fa-info-circle"></i> ${message}
            `;
            errorMessage.classList.add('show');
            // Mavi bilgilendirme stili
            errorMessage.style.backgroundColor = '#d1ecf1';
            errorMessage.style.color = '#0c5460';
            errorMessage.style.border = '2px solid #17a2b8';
        }

        function hideError() {
            errorMessage.classList.remove('show');
        }

        function showResults(result) {
            console.log('showResults called with:', result); // Debug log
            
            // Analiz verisini sakla deƒüerlendirme i√ßin
            currentAnalysisData = result.data || result;
            
            const visualResults = document.getElementById('visualResults');
            const serviceName = documentType.options[documentType.selectedIndex].text;
            
            // Extract data based on new standardized format
            const data = result.data || result;
            const isSuccess = result.success !== false;
            
            console.log('Extracted data:', data); // Debug log
            console.log('Is success:', isSuccess); // Debug log
            
            if (!isSuccess) {
                showError(result.message || 'Analiz ba≈üarƒ±sƒ±z oldu.');
                return;
            }

            // Create visual results HTML
            let html = `
                <div class="result-header">
                    <div class="result-title">
                        <i class="fas fa-chart-line"></i>
                        ${serviceName}
                    </div>
                    <div class="result-badge ${getStatusBadgeClass(data.overall_score?.status)}">
                        ${getStatusText(data.overall_score?.status)}
                    </div>
                </div>

                <div class="score-section">
                    <div class="score-card">
                        <div class="score-value score-percentage">${data.overall_score?.percentage || 0}%</div>
                        <div class="score-label">Ba≈üarƒ± Oranƒ±</div>
                    </div>
                </div>

                <div class="info-section">
                    <div class="info-title">
                        <i class="fas fa-info-circle"></i> Analiz Bilgileri
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">üìÑ Dosya Adƒ±:</span>
                            <span class="info-value">${data.filename || selectedFile.name}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">üìÖ Analiz Tarihi:</span>
                            <span class="info-value">${data.analysis_date || new Date().toLocaleString('tr-TR')}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">üîç Analiz ID:</span>
                            <span class="info-value">${data.analysis_id || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">üìã Dosya T√ºr√º:</span>
                            <span class="info-value">${data.file_type || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            `;

            // Add category scores if available
            if (data.category_scores && Object.keys(data.category_scores).length > 0) {
                html += `
                    <div class="info-section">
                        <div class="info-title">
                            <i class="fas fa-tasks"></i> Kategori Puanlarƒ±
                        </div>
                        <div class="category-scores">
                `;
                
                for (const [category, score] of Object.entries(data.category_scores)) {
                    const percentage = score.percentage || score.percentage || 0;
                    html += `
                        <div class="category-card">
                            <div class="category-name">${category}</div>
                            <div class="category-score">
                                <span class="category-percentage">${percentage}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }

            // Add extracted values if available
            if (data.extracted_values && Object.keys(data.extracted_values).length > 0) {
                html += `
                    <div class="info-section">
                        <div class="info-title">
                            <i class="fas fa-search"></i> √áƒ±karƒ±lan Deƒüerler
                        </div>
                        <div class="info-grid">
                `;
                
                for (const [key, value] of Object.entries(data.extracted_values)) {
                    if (value && value !== 'N/A' && value !== 'Bulunamadƒ±') {
                        html += `
                            <div class="info-item">
                                <span class="info-label">${formatLabel(key)}:</span>
                                <span class="info-value">${value}</span>
                            </div>
                        `;
                    }
                }
                
                html += `
                        </div>
                    </div>
                `;
            }

            // Add recommendations if available
            if (data.recommendations && data.recommendations.length > 0) {
                html += `
                    <div class="recommendations-section">
                        <div class="info-title">
                            <i class="fas fa-lightbulb"></i> √ñneriler
                        </div>
                `;
                
                data.recommendations.slice(0, 5).forEach(recommendation => {
                    html += `<div class="recommendation-item">${recommendation}</div>`;
                });
                
                html += `</div>`;
            }

            // Add summary if available
            if (data.summary) {
                html += `
                    <div class="info-section">
                        <div class="info-title">
                            <i class="fas fa-clipboard-check"></i> √ñzet
                        </div>
                        <p style="color: #4a5568; line-height: 1.6;">${data.summary}</p>
                    </div>
                `;
            }

            visualResults.innerHTML = html;
            
            // Show JSON result (hidden by default)
            resultsJson.textContent = JSON.stringify(result, null, 2);
            
            // Show results section
            resultsSection.classList.add('show');

            // Show issue report section
            document.getElementById('issueReportSection').style.display = 'block';
            autoCreateTicket();
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function getStatusBadgeClass(status) {
            if (!status) return 'badge-warning';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('pass') || statusLower.includes('ba≈üarƒ±lƒ±')) return 'badge-success';
            if (statusLower.includes('fail') || statusLower.includes('ba≈üarƒ±sƒ±z')) return 'badge-error';
            return 'badge-warning';
        }

        function getStatusText(status) {
            if (!status) return 'SONU√á YOK';
            const statusLower = status.toLowerCase();
            if (statusLower.includes('pass')) return 'BA≈ûARILI';
            if (statusLower.includes('fail')) return 'BA≈ûARISIZ';
            return status.toUpperCase();
        }

        function formatLabel(key) {
            const labelMap = {
                'firma_adi': 'üè¢ Firma Adƒ±',
                'rapor_no': 'üìã Rapor No',
                'rapor_numarasi': 'üìã Rapor Numarasƒ±',
                'olcum_tarihi': 'üìÖ √ñl√ß√ºm Tarihi',
                'makine_adi': '‚öôÔ∏è Makine Adƒ±',
                'cihaz_marka': 'üîß Cihaz Marka',
                'olcum_yapan': 'üë§ √ñl√ß√ºm Yapan',
                'laboratuvar': 'üî¨ Laboratuvar',
                'adres': 'üìç Adres',
                'gurultu_seviye': 'üîä G√ºr√ºlt√º Seviyesi',
                'aydinlatma_seviye': 'üí° Aydƒ±nlatma Seviyesi',
                'manufacturer_name': 'üè≠ √úretici Adƒ±',
                'machine_description': 'üìù Makine A√ßƒ±klamasƒ±',
                'serial_number': 'üî¢ Seri Numarasƒ±',
                'production_year': 'üìÖ √úretim Yƒ±lƒ±'
            };
            return labelMap[key] || key.replace(/_/g, ' ').toUpperCase();
        }

                function toggleJsonView() {
                    const jsonDiv = document.getElementById('resultsJson');
                    const toggleBtn = document.getElementById('toggleJsonBtn');
                    const parent = document.getElementById('resultsSection');
                    parent.classList.toggle('json-open');
                    if (jsonDiv.style.display === 'block') {
                        jsonDiv.style.display = 'none';
                        toggleBtn.textContent = 'JSON';
                    } else {
                        jsonDiv.style.display = 'block';
                        toggleBtn.textContent = 'G√∂rsel';
                    }
                }

        function resetForm() {
            selectedFile = null;
            fileInput.value = '';
            documentType.value = '';
            fileInfo.classList.remove('show');
            resultsSection.classList.remove('show');
            checkFormValidity();
            hideError();
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Deƒüerlendirme b√∂l√ºm√º fonksiyonlarƒ±
        let currentAnalysisData = null;

        function showEvaluationSection() {
            if (!currentAnalysisData) {
                alert('√ñnce bir analiz yapmalƒ±sƒ±nƒ±z!');
                return;
            }

            // Deƒüerlendirme formunu doldur
            document.getElementById('evalDocumentName').value = currentAnalysisData.filename || 'Bilinmiyor';
            document.getElementById('evalDocumentSize').value = formatFileSize(selectedFile?.size || 0);
            document.getElementById('evalDocumentType').value = getDocumentTypeText(currentAnalysisData.file_type);
            document.getElementById('evalAnalysisDate').value = currentAnalysisData.analysis_date || new Date().toLocaleString('tr-TR');
            
            // Deƒüerlendirme b√∂l√ºm√ºn√º g√∂ster
            document.getElementById('evaluationSection').style.display = 'block';
            document.getElementById('evaluationSection').scrollIntoView({ behavior: 'smooth' });
        }

        function hideEvaluationSection() {
            document.getElementById('evaluationSection').style.display = 'none';
            document.getElementById('evaluationNotes').value = '';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getDocumentTypeText(fileType) {
            const typeMap = {
                'electric_circuit': 'üîå Elektrik Devre ≈ûemasƒ±',
                'espe_report': 'üìã ESPE Raporu',
                'hydraulic_report': 'üíß Hidrolik Devre ≈ûemasƒ±',
                'noise_report': 'üîä G√ºr√ºlt√º √ñl√ß√ºm Raporu',
                'manuel_report': 'üìñ Manuel/Kullanƒ±m Kƒ±lavuzu',
                'loto_report': 'üîí LOTO Raporu',
                'lvd_report': '‚ö° LVD Raporu',
                'at_type_inspection': 'üîç AT Tip Muayene',
                'isg_periyodik_kontrol': 'üõ°Ô∏è ƒ∞SG Periyodik Kontrol',
                'pneumatic_circuit': 'üí® Pn√∂matik Devre ≈ûemasƒ±',
                'hydraulic_circuit': 'üîß Hidrolik Devre ≈ûemasƒ±',
                'assembly_instructions': 'üî® Montaj Talimatlarƒ±',
                'grounding_report': '‚ö° EN 60204-1 Topraklama Raporu',
                'hrc_report': 'ü§ñ HRC Kuvvet-Basƒ±n√ß Raporu',
                'maintenance_instructions': 'üîß Bakƒ±m Talimatlarƒ±',
                'vibration_report': 'üì≥ Mekanik Titre≈üim Raporu',
                'lighting_report': 'üí° Aydƒ±nlatma Raporu',
                'at_certificate': 'üìú AT Tip ƒ∞nceleme Sertifikasƒ±'
            };
            return typeMap[fileType] || fileType || 'Bilinmiyor';
        }

        async function saveEvaluation() {
            const evaluationNotes = document.getElementById('evaluationNotes').value.trim();
            
            if (!evaluationNotes) {
                alert('L√ºtfen deƒüerlendirme notlarƒ±nƒ± giriniz!');
                return;
            }

            if (!currentAnalysisData) {
                alert('Analiz verisi bulunamadƒ±!');
                return;
            }

            // Deƒüerlendirme verisini hazƒ±rla
            const evaluationData = {
                timestamp: new Date().toISOString(),
                analysis_date: currentAnalysisData.analysis_date,
                document_name: currentAnalysisData.filename,
                document_extension: currentAnalysisData.filename ? currentAnalysisData.filename.split('.').pop() : 'unknown',
                document_size: formatFileSize(selectedFile?.size || 0),
                document_size_bytes: selectedFile?.size || 0,
                report_type: currentAnalysisData.file_type,
                report_type_display: getDocumentTypeText(currentAnalysisData.file_type),
                analysis_id: currentAnalysisData.analysis_id,
                overall_score: currentAnalysisData.overall_score,
                evaluation_notes: evaluationNotes,
                analysis_data: currentAnalysisData
            };

            try {
                // API'ye deƒüerlendirmeyi g√∂nder
                const response = await fetch('/api/save-evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(evaluationData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('Deƒüerlendirme ba≈üarƒ±yla kaydedildi!');
                    hideEvaluationSection();
                } else {
                    throw new Error(result.message || 'Deƒüerlendirme kaydedilemedi');
                }
            } catch (error) {
                console.error('Deƒüerlendirme kaydetme hatasƒ±:', error);
                alert('Deƒüerlendirme kaydedilirken bir hata olu≈ütu: ' + error.message);
            }
        }

        async function reportIssue() {
            const inspectorComment = document.getElementById('inspectorComment').value.trim();
            const inspectorName = document.getElementById('inspectorName').value.trim() || 'Kullanƒ±cƒ±';
            
            if (!inspectorComment) {
                alert('L√ºtfen yorumunuzu giriniz!');
                return;
            }

            if (!currentAnalysisData) {
                alert('Analiz verisi bulunamadƒ±!');
                return;
            }

            let activeToast = null;
            if (AUTHORIZED_USERS.includes(inspectorName)) {
                activeToast = showToast('ü§ñ AI pattern analizi yapƒ±lƒ±yor...', 'info', 0);
            }

            try {
                const ticketsResponse = await fetch('/api/tickets');
                const tickets = await ticketsResponse.json();
                
                const existingTicket = tickets.find(t => 
                    t.ticket_id === currentAnalysisData.analysis_id
                );
                
                if (existingTicket) {
                    const commentResponse = await fetch('/api/add-comment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            ticket_no: existingTicket.ticket_no,
                            author: inspectorName,
                            text: inspectorComment
                        })
                    });
                    
                    const commentResult = await commentResponse.json();
                    
                    if (activeToast) {
                        closeToast(activeToast.querySelector('.toast-close'));
                    }
                    
                    if (commentResponse.ok && commentResult.success) {
                        const statusResponse = await fetch('/api/update-ticket', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ticket_no: existingTicket.ticket_no,
                                status: 'ƒ∞nceleniyor'
                            })
                        });
                        
                        if (statusResponse.ok) {
                            showToast(commentResult.message, 'success', 5000);
                            document.getElementById('inspectorName').value = '';
                            document.getElementById('inspectorComment').value = '';
                            document.getElementById('issueReportSection').style.display = 'none';
                        }
                    } else {
                        throw new Error(commentResult.message || 'Yorum eklenemedi');
                    }
                } else {
                    const issueData = {
                        inspector_name: inspectorName,
                        inspector_comment: inspectorComment,
                        document_name: currentAnalysisData.filename || selectedFile.name,
                        analysis_data: currentAnalysisData
                    };
                    
                    const response = await fetch('/api/report-issue', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(issueData)
                    });
                    
                    const result = await response.json();
                    
                    if (activeToast) {
                        closeToast(activeToast.querySelector('.toast-close'));
                    }
                    
                    if (response.ok && result.success) {
                        showToast(`‚úÖ Ticket olu≈üturuldu! (${result.ticket_no})`, 'success', 5000);
                        document.getElementById('inspectorName').value = '';
                        document.getElementById('inspectorComment').value = '';
                        document.getElementById('issueReportSection').style.display = 'none';
                    } else {
                        throw new Error(result.message || 'Ticket olu≈üturulamadƒ±');
                    }
                }
            } catch (error) {
                if (activeToast) {
                    closeToast(activeToast.querySelector('.toast-close'));
                }
                console.error('Hata:', error);
                showToast('‚ùå ƒ∞≈ülem ba≈üarƒ±sƒ±z: ' + error.message, 'error', 5000);
            }
        }

        async function autoCreateTicket() {
            if (!currentAnalysisData) return;

            try {
                // √ñnce bu ticket_id i√ßin ticket var mƒ± kontrol et
                const ticketsResponse = await fetch('/api/tickets');
                const tickets = await ticketsResponse.json();
                
                const existingTicket = tickets.find(t => 
                    t.ticket_id === currentAnalysisData.analysis_id
                );
                
                if (existingTicket) {
                    console.log('Bu analiz i√ßin ticket zaten var:', existingTicket.ticket_no);
                    return; // Zaten var, yeni olu≈üturma
                }

                // Yoksa olu≈ütur
                const issueData = {
                    inspector_name: '',  // BO≈û
                    inspector_comment: '',  // BO≈û
                    document_name: currentAnalysisData.filename || selectedFile.name,
                    analysis_data: currentAnalysisData
                };

                await fetch('/api/report-issue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(issueData)
                });

                console.log('Otomatik ticket olu≈üturuldu (Kapalƒ±)');
            } catch (error) {
                console.error('Otomatik ticket hatasƒ±:', error);
            }
        }

        // Initialize
        // View switching functionality
        const analysisBtn = document.getElementById('analysisBtn');
        const evaluationBtn = document.getElementById('evaluationBtn');
        const analysisView = document.getElementById('analysisView');
        const evaluationView = document.getElementById('evaluationView');

        analysisBtn.addEventListener('click', () => {
            showAnalysisView();
        });

        evaluationBtn.addEventListener('click', () => {
            showEvaluationView();
        });

        const ticketsBtn = document.getElementById('ticketsBtn');
        const ticketsView = document.getElementById('ticketsView');

        ticketsBtn.addEventListener('click', () => {
            showTicketsView();
        });

        function showAnalysisView() {
            analysisView.style.display = 'block';
            evaluationView.style.display = 'none';
            ticketsView.style.display = 'none'; 
            analysisBtn.classList.add('selected');
            evaluationBtn.classList.remove('selected');
            ticketsBtn.classList.remove('selected');
        }

        function showEvaluationView() {
            analysisView.style.display = 'none';
            evaluationView.style.display = 'block';
            ticketsView.style.display = 'none';
            analysisBtn.classList.remove('selected');
            evaluationBtn.classList.add('selected');
            ticketsBtn.classList.remove('selected');
            loadEvaluations();
        }

        function showTicketsView() {
            analysisView.style.display = 'none';
            evaluationView.style.display = 'none';
            ticketsView.style.display = 'block';
            analysisBtn.classList.remove('selected');
            evaluationBtn.classList.remove('selected');
            ticketsBtn.classList.add('selected');

            // Tickets'larƒ± y√ºkle
            loadTickets();
        }

        async function loadTickets() {
            try {
                // Show loading
                document.getElementById('ticketsContent').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div class="spinner" style="margin: 0 auto 1rem;"></div>
                        <p>Tickets y√ºkleniyor...</p>
                    </div>
                `;

                const response = await fetch('/api/tickets');
                if (!response.ok) {
                    throw new Error('Tickets y√ºklenemedi');
                }

                const tickets = await response.json();
                displayTickets(tickets);

            } catch (error) {
                console.error('Tickets loading error:', error);
                document.getElementById('ticketsContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--danger);">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <h3>Tickets y√ºklenemedi</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function searchTickets() {
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const responsibleFilter = document.getElementById('responsibleFilter').value;
            // Query string olu≈ütur
            const params = new URLSearchParams();
            if (statusFilter) params.append('status', statusFilter);
            if (dateFrom) params.append('date_from', dateFrom);
            if (dateTo) params.append('date_to', dateTo);
            if (responsibleFilter) params.append('responsible', responsibleFilter);

            // Backend'e filtreli istek at
            const url = params.toString() ? `/api/tickets?${params.toString()}` : '/api/tickets';
            
            fetch(url)
                .then(response => response.json())
                .then(tickets => {
                    displayTickets(tickets);
                })
                .catch(error => {
                    console.error('Arama hatasƒ±:', error);
                });
        }

        function displayTickets(tickets) {
            const ticketsContent = document.getElementById('ticketsContent');
            
            if (!tickets || tickets.length === 0) {
                ticketsContent.innerHTML = `
                    <div class="placeholder-content">
                        <i class="fa-solid fa-ticket" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
                        <h3>Hen√ºz ticket bulunmuyor</h3>
                        <p style="color: var(--text-dim);">Analiz sonrasƒ± "Sorun Bildir" butonunu kullanarak ticket olu≈üturabilirsiniz</p>
                    </div>
                `;
                return;
            }

            const ticketsHtml = tickets.map((ticket, index) => {
                const openingDate = new Date(ticket.opening_date).toLocaleDateString('tr-TR');
                const scorePercentage = ticket.analysis_result?.overall_score?.percentage || 0;
                const status = ticket.status || 'ƒ∞nceleniyor';
                
                // Status rengi
                let statusClass = 'unknown';
                if (status === 'Kapalƒ±') statusClass = 'success';
                else if (status === 'Sorunlu') statusClass = 'fail';
                
                return `
                    <div class="ticket-row" onclick="openTicketDetail('${ticket.ticket_no}')">
                        <div class="ticket-main">
                            <div class="ticket-icon">
                                <i class="fa-solid fa-ticket"></i>
                            </div>
                            <div class="ticket-info">
                                <div class="ticket-header-row">
                                    <span class="ticket-number">#${ticket.ticket_no}</span>
                                    <span class="ticket-filename">${ticket.document_name}</span>
                                </div>
                                <div class="ticket-meta-row">
                                    <span><i class="fa-solid fa-calendar"></i> ${openingDate}</span>
                                    <span><i class="fa-solid fa-user"></i> ${ticket.responsible}</span>
                                </div>
                            </div>
                        </div>
                        <div class="ticket-status ${statusClass}">
                            <span class="status-badge">${status}</span>
                            <span class="score-value">${scorePercentage}%</span>
                        </div>
                    </div>
                `;
            }).join('');

            ticketsContent.innerHTML = `
                <div class="evaluation-grid">
                    ${ticketsHtml}
                </div>
            `;
        }

        async function openTicketDetail(ticketNo) {
            try {
                const response = await fetch('/api/tickets');
                const tickets = await response.json();

                // ticket_no'ya g√∂re doƒüru ticket'ƒ± bul
                const ticket = tickets.find(t => t.ticket_no === ticketNo);

                if (!ticket) {
                    alert('Ticket bulunamadƒ±');
                    return;
                }

                showTicketDetailModal(ticket);
            } catch (error) {
                console.error('Ticket detay y√ºklenirken hata:', error);
                alert('Ticket detaylarƒ± y√ºklenemedi');
            }
        }

        function showTicketDetailModal(ticket) {
            const scorePercentage = ticket.analysis_result?.overall_score?.percentage || 0;
            const status = ticket.status || 'ƒ∞nceleniyor';
            const openingDate = new Date(ticket.opening_date).toLocaleString('tr-TR');
            const closingDate = ticket.closing_date ? new Date(ticket.closing_date).toLocaleString('tr-TR') : 'Devam ediyor';
            
            let statusClass = 'unknown';
            if (status === 'Kapalƒ±') statusClass = 'success';
            else if (status === 'Sorunlu') statusClass = 'fail';
            
            let categoryScoresHtml = '';
            if (ticket.analysis_result?.category_scores) {
                categoryScoresHtml = `
                    <div class="detail-section">
                        <h4>Kategori Puanlarƒ±</h4>
                        <div class="category-list">
                            ${Object.entries(ticket.analysis_result.category_scores).map(([category, score]) => `
                                <div class="category-item">
                                    <span class="category-name">${category}</span>
                                    <span class="category-score">${score.percentage || 0}%</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${score.percentage || 0}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            let extractedValuesHtml = '';
            if (ticket.analysis_result?.extracted_values && Object.keys(ticket.analysis_result.extracted_values).length > 0) {
                extractedValuesHtml = `
                    <div class="detail-section">
                        <h4>√áƒ±karƒ±lan Deƒüerler</h4>
                        <div class="detail-grid">
                            ${Object.entries(ticket.analysis_result.extracted_values).map(([key, value]) => {
                                if (value && value !== 'N/A' && value !== 'Bulunamadƒ±') {
                                    return `
                                        <div class="detail-item">
                                            <span class="detail-label">${formatLabel(key)}:</span>
                                            <span class="detail-value">${value}</span>
                                        </div>
                                    `;
                                }
                                return '';
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            let recommendationsHtml = '';
            if (ticket.analysis_result?.recommendations && ticket.analysis_result.recommendations.length > 0) {
                recommendationsHtml = `
                    <div class="detail-section">
                        <h4>√ñneriler</h4>
                        <div style="display: grid; gap: 0.6rem;">
                            ${ticket.analysis_result.recommendations.slice(0, 10).map(rec => `
                                <div class="recommendation-item">${rec}</div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            const modalHtml = `
                <div id="ticketModal" class="modal-overlay" onclick="closeTicketModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3><i class="fa-solid fa-ticket"></i> ${ticket.ticket_no} - ${ticket.document_name}</h3>
                            <div class="modal-header-actions">
                                <button class="btn-delete-ticket" onclick="deleteTicket('${ticket.ticket_no}')" title="Ticket'ƒ± Sil">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                                <button onclick="closeTicketModal()" class="modal-close">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="detail-section">
                                <h4>Ticket Bilgileri</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">Ticket No:</span>
                                        <span class="detail-value">${ticket.ticket_no}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Ticket ID:</span>
                                        <span class="detail-value">${ticket.ticket_id || 'N/A'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Durum:</span>
                                        <select id="statusSelect" class="status-select ${statusClass}">
                                            <option value="ƒ∞nceleniyor" ${status === 'ƒ∞nceleniyor' ? 'selected' : ''}>ƒ∞nceleniyor</option>
                                            <option value="Onaylanmadƒ±" ${status === 'Onaylanmadƒ±' ? 'selected' : ''}>Onaylanmadƒ±</option>
                                            <option value="Sorunlu" ${status === 'Sorunlu' ? 'selected' : ''}>Sorunlu</option>
                                            <option value="Kapalƒ±" ${status === 'Kapalƒ±' ? 'selected' : ''}>Kapalƒ±</option>
                                        </select>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Sorumlu:</span>
                                        <input type="text" id="ticketResponsible" class="responsible-input" value="${ticket.responsible}" />
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">A√ßƒ±lma Tarihi:</span>
                                        <span class="detail-value">${openingDate}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Son G√ºncelleme:</span>
                                        <span class="detail-value">${ticket.last_updated && ticket.last_updated !== null ? new Date(ticket.last_updated).toLocaleString('tr-TR') : '-'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Kapanma Tarihi:</span>
                                        <span class="detail-value">${ticket.closing_date ? new Date(ticket.closing_date).toLocaleString('tr-TR') : '-'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Dosya ƒ∞ndir:</span>
                                        <span class="detail-value">
                                            <a href="${ticket.document_url}" target="_blank" class="download-link">
                                                <i class="fa-solid fa-download"></i> ${ticket.document_name}
                                            </a>
                                        </span>
                                    </div>
                                    <div class="detail-item detail-item-full">
                                        <button class="btn-save-ticket" onclick="saveTicketChanges('${ticket.ticket_no}')">
                                            <i class="fa-solid fa-save"></i> Deƒüi≈üiklikleri Kaydet
                                        </button>
                                    </div>
                                </div>
                            </div>      
                            <div class="detail-section">
                                <h4>Analiz Sonucu</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">Toplam Puan:</span>
                                        <span class="detail-value ${statusClass}">${scorePercentage}%</span>
                                    </div>
                                </div>
                            </div>
                            
                            ${categoryScoresHtml}

                            ${extractedValuesHtml}
                            
                            ${recommendationsHtml}
                            
                            <div class="detail-section">
                                <h4>Yorumlar</h4>
                                <div class="comments-container" id="commentsContainer">
                                    ${ticket.comments && ticket.comments.length > 0 ? 
                                        ticket.comments.map(comment => `
                                            <div class="comment-item">
                                                <div class="comment-header">
                                                    <span class="comment-author">${comment.author}</span>
                                                    <span class="comment-time">${new Date(comment.timestamp).toLocaleString('tr-TR')}</span>
                                                </div>
                                                <div class="comment-text">${comment.text}</div>
                                            </div>
                                        `).join('') 
                                        : 
                                        '<p class="no-comments">Hen√ºz yorum yok</p>'
                                    }
                                </div>
                                
                                <div class="add-comment-section">
                                    <input type="text" id="commentAuthor" class="comment-input-name" placeholder="ƒ∞sminiz..." />
                                    <textarea id="commentText" class="comment-input-text" placeholder="Yorumunuzu yazƒ±n..." rows="3"></textarea>
                                    <button class="btn-add-comment" onclick="addComment('${ticket.ticket_no}')">
                                        <i class="fa-solid fa-paper-plane"></i> Yorum Ekle
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        async function saveTicketChanges(ticketNo) {
           
            console.log('Kaydet butonu √ßalƒ±≈ütƒ±:', ticketNo); // Test i√ßin

            const newStatus = document.getElementById('statusSelect').value;
            const newResponsible = document.getElementById('ticketResponsible').value.trim();
            
            console.log('Status:', newStatus, 'Responsible:', newResponsible); // Test i√ßin

            if (!newResponsible) {
                alert('Sorumlu ki≈üi bo≈ü olamaz!');
                return;
            }
            
            try {
                const response = await fetch('/api/update-ticket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticket_no: ticketNo,
                        status: newStatus,
                        responsible: newResponsible
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('‚úì Deƒüi≈üiklikler kaydedildi!');
                    loadTickets(); // Listeyi yenile
                    closeTicketModal();
                } else {
                    alert('G√ºncelleme ba≈üarƒ±sƒ±z: ' + result.message);
                }
            } catch (error) {
                console.error('G√ºncelleme hatasƒ±:', error);
                alert('G√ºncellenirken hata olu≈ütu');
            }
        }

        async function deleteTicket(ticketNo) {
            // Onay dialogu
            const confirmed = confirm(`${ticketNo} numaralƒ± ticket'ƒ± silmek istediƒüinize emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!`);
            
            if (!confirmed) return;
            
            try {
                const response = await fetch('/api/delete-ticket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticket_no: ticketNo })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('‚úì Ticket ba≈üarƒ±yla silindi!');
                    closeTicketModal();
                    loadTickets(); // Listeyi yenile
                } else {
                    alert('Ticket silinemedi: ' + result.message);
                }
            } catch (error) {
                console.error('Silme hatasƒ±:', error);
                alert('Ticket silinirken hata olu≈ütu');
            }
        }

        async function addComment(ticketNo) {
            const author = document.getElementById('commentAuthor').value.trim();
            const text = document.getElementById('commentText').value.trim();
            
            if (!author) {
                alert('L√ºtfen isminizi girin');
                return;
            }
            
            if (!text) {
                alert('L√ºtfen yorum yazƒ±n');
                return;
            }
            
            let activeToast = null;
            if (AUTHORIZED_USERS.includes(author)) {
                activeToast = showToast('ü§ñ AI pattern analizi yapƒ±lƒ±yor...', 'info', 0);
            }
            
            try {
                const response = await fetch('/api/add-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ticket_no: ticketNo,
                        author: author,
                        text: text
                    })
                });
                
                const result = await response.json();
                
                if (activeToast) {
                    closeToast(activeToast.querySelector('.toast-close'));
                }
                
                if (response.ok && result.success) {
                    showToast(result.message, 'success', 5000);
                    
                    document.getElementById('commentAuthor').value = '';
                    document.getElementById('commentText').value = '';
                    
                    await loadTickets();
                    
                    const ticketsResponse = await fetch('/api/tickets');
                    const tickets = await ticketsResponse.json();
                    const updatedTicket = tickets.find(t => t.ticket_no === ticketNo);
                    
                    if (updatedTicket) {
                        const commentsContainer = document.getElementById('commentsContainer');
                        if (updatedTicket.comments && updatedTicket.comments.length > 0) {
                            commentsContainer.innerHTML = updatedTicket.comments.map(comment => `
                                <div class="comment-item">
                                    <div class="comment-header">
                                        <span class="comment-author">${comment.author}</span>
                                        <span class="comment-time">${new Date(comment.timestamp).toLocaleString('tr-TR')}</span>
                                    </div>
                                    <div class="comment-text">${comment.text}</div>
                                </div>
                            `).join('');
                        } else {
                            commentsContainer.innerHTML = '<p class="no-comments">Hen√ºz yorum yok</p>';
                        }
                    }
                } else {
                    showToast('‚ùå Yorum eklenemedi: ' + result.message, 'error', 5000);
                }
            } catch (error) {
                if (activeToast) {
                    closeToast(activeToast.querySelector('.toast-close'));
                }
                console.error('Yorum ekleme hatasƒ±:', error);
                showToast('‚ùå Yorum eklenirken hata olu≈ütu', 'error', 5000);
            }
        }

        function closeTicketModal() {
            const modal = document.getElementById('ticketModal');
            if (modal) {
                modal.remove();
            }
        }

        // Load evaluations from JSON file
        function getReportTypeFromAnalysisId(analysisId) {
            if (!analysisId) return 'Bilinmeyen';
            
            // analysis_id formatƒ±: "pneumatic_1757931642" ≈üeklinde
            const reportTypeMap = {
                'electric_circuit': 'Elektrik Devre ≈ûemasƒ±',
                'espe_report': 'ESPE Raporu',
                'hydraulic_report': 'Hidrolik Devre ≈ûemasƒ±',
                'noise_report': 'G√ºr√ºlt√º √ñl√ß√ºm Raporu',
                'manuel_report': 'Manuel Raporu',
                'loto_report': 'LOTO Raporu',
                'lvd_report': 'LVD Raporu',
                'at_type_inspection': 'AT Tip Muayene',
                'isg_periyodik_kontrol': 'ƒ∞SG Periyodik Kontrol',
                'pneumatic_circuit': 'Pn√∂matik Devre ≈ûemasƒ±',
                'pneumatic': 'Pn√∂matik Devre ≈ûemasƒ±',
                'hydraulic_circuit': 'Hidrolik Devre ≈ûemasƒ±',
                'assembly_instructions': 'Montaj Talimatlarƒ±',
                'grounding_report': 'Topraklama Raporu',
                'hrc_report': 'HRC Kuvvet-Basƒ±n√ß Raporu',
                'maintenance_instructions': 'Bakƒ±m Talimatlarƒ±',
                'vibration_report': 'Titre≈üim Raporu',
                'lighting_report': 'Aydƒ±nlatma Raporu',
                'at_certificate': 'AT Tip ƒ∞nceleme Sertifikasƒ±'
            };
            
            // analysis_id'den ilk kƒ±smƒ± al (√∂rn: "pneumatic_1757931642" -> "pneumatic")
            const reportType = analysisId.split('_')[0];
            return reportTypeMap[reportType] || reportType || 'Bilinmeyen';
        }
        async function loadEvaluations() {
            try {
                // Show loading in evaluation grid
                document.getElementById('evaluationGrid').innerHTML = `
                    <div style="text-align: center; padding: 2rem; grid-column: 1/-1;">
                        <div class="spinner" style="margin: 0 auto 1rem;"></div>
                        <p>Deƒüerlendirmeler y√ºkleniyor...</p>
                    </div>
                `;

                const response = await fetch('/api/evaluations');
                if (!response.ok) {
                    throw new Error('Deƒüerlendirmeler y√ºklenemedi');
                }

                const evaluations = await response.json();
                displayEvaluations(evaluations);

            } catch (error) {
                console.error('Evaluation loading error:', error);
                document.getElementById('evaluationGrid').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--danger); grid-column: 1/-1;">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <h3>Deƒüerlendirmeler y√ºklenemedi</h3>
                        <p>API baƒülantƒ± hatasƒ±: ${error.message}</p>
                    </div>
                `;
            }
        }

        function displayEvaluations(evaluations) {
            const evaluationGrid = document.getElementById('evaluationGrid');
            
            if (!evaluations || evaluations.length === 0) {
                evaluationGrid.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-dim); grid-column: 1/-1;">
                        <i class="fa-solid fa-chart-bar" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
                        <h3>Hen√ºz deƒüerlendirme bulunmuyor</h3>
                        <p>Rapor analizlerini deƒüerlendirmeye ba≈ülayƒ±n</p>
                    </div>
                `;
                return;
            }

            const evaluationCards = evaluations.map(evaluation => {
                const scorePercentage = evaluation.overall_score?.percentage || 0;
                const status = evaluation.overall_score?.status || 'UNKNOWN';
                
                // Status kontrol√ºn√º geni≈ület - GE√áERLƒ∞, PASS, ve puan kontrol√º
                let statusClass, statusIcon, statusText;
                if (status === 'PASS' || status === 'GE√áERLƒ∞' || (scorePercentage >= 70 && (status === 'GE√áERLƒ∞' || status === 'PASS'))) {
                    statusClass = 'success';
                    statusIcon = 'fa-check-circle';
                    statusText = 'BA≈ûARILI';
                } else if (status === 'FAIL' || status === 'GE√áERSƒ∞Z' || (scorePercentage < 70)) {
                    statusClass = 'fail';
                    statusIcon = 'fa-times-circle';
                    statusText = 'BA≈ûARISIZ';
                } else {
                    statusClass = 'unknown';
                    statusIcon = 'fa-question-circle';
                    statusText = 'Bƒ∞Lƒ∞NMƒ∞YOR';
                }
                
                const date = new Date(evaluation.timestamp).toLocaleDateString('tr-TR');
                const reportTypeText = getReportTypeFromAnalysisId(evaluation.analysis_id);
                
                return `
                    <div class="evaluation-card" onclick="openEvaluationDetail('${evaluation.analysis_id}', ${evaluations.indexOf(evaluation)})">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fa-solid fa-file-text"></i>
                                <span class="document-name">${evaluation.document_name}</span>
                            </div>
                        </div>
                        
                        <div class="card-meta">
                            <div class="meta-item">
                                <i class="fa-solid fa-calendar"></i>
                                <span>${date}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fa-solid fa-tag"></i>
                                <span>${reportTypeText}</span>
                            </div>
                            <div class="meta-item">
                                <i class="fa-solid fa-hdd"></i>
                                <span>${evaluation.document_size}</span>
                            </div>
                        </div>
                        
                        <div class="card-notes">
                            <p>${evaluation.evaluation_notes?.substring(0, 80)}${evaluation.evaluation_notes?.length > 80 ? '...' : ''}</p>
                        </div>
                        
                        <div class="card-score ${statusClass}">
                            <i class="fa-solid ${statusIcon}"></i>
                            <span class="score-text">${scorePercentage}% - ${statusText}</span>
                        </div>
                    </div>
                `;
            }).join('');

            evaluationGrid.innerHTML = evaluationCards;
        }

        function openEvaluationDetail(analysisId, index) {
            fetch('/api/evaluations')
                .then(response => response.json())
                .then(evaluations => {
                    const evaluation = evaluations[index];
                    if (evaluation) {
                        showEvaluationDetailModal(evaluation);
                    }
                })
                .catch(error => {
                    console.error('Detail loading error:', error);
                    alert('Detay bilgileri y√ºklenemedi');
                });
        }

        function showEvaluationDetailModal(evaluation) {
            const scorePercentage = evaluation.overall_score?.percentage || 0;
            const status = evaluation.overall_score?.status || 'UNKNOWN';
            
            // Status kontrol√ºn√º geni≈ület - GE√áERLƒ∞, PASS, ve puan kontrol√º
            let statusClass, statusText;
            if (status === 'PASS' || status === 'GE√áERLƒ∞' || (scorePercentage >= 70 && (status === 'GE√áERLƒ∞' || status === 'PASS'))) {
                statusClass = 'success';
                statusText = 'BA≈ûARILI';
            } else if (status === 'FAIL' || status === 'GE√áERSƒ∞Z' || (scorePercentage < 70)) {
                statusClass = 'fail';
                statusText = 'BA≈ûARISIZ';
            } else {
                statusClass = 'unknown';
                statusText = 'Bƒ∞Lƒ∞NMƒ∞YOR';
            }
            
            const reportTypeText = getReportTypeFromAnalysisId(evaluation.analysis_id);
            
            let categoryScoresHtml = '';
            if (evaluation.analysis_data?.category_scores) {
                categoryScoresHtml = `
                    <div class="detail-section">
                        <h4>Kategori Puanlarƒ±</h4>
                        <div class="category-list">
                            ${Object.entries(evaluation.analysis_data.category_scores).map(([category, score]) => `
                                <div class="category-item">
                                    <span class="category-name">${category}</span>
                                    <span class="category-score">${score.percentage || 0}%</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${score.percentage || 0}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            const modalHtml = `
                <div id="evaluationModal" class="modal-overlay" onclick="closeEvaluationModal()">
                    <div class="modal-content" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3><i class="fa-solid fa-chart-line"></i> ${evaluation.document_name}</h3>
                            <button onclick="closeEvaluationModal()" class="modal-close">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="detail-section">
                                <h4>Genel Bilgiler</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">Rapor T√ºr√º:</span>
                                        <span class="detail-value">${reportTypeText}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Analiz Tarihi:</span>
                                        <span class="detail-value">${new Date(evaluation.timestamp).toLocaleString('tr-TR')}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Dosya Boyutu:</span>
                                        <span class="detail-value">${evaluation.document_size}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Toplam Puan:</span>
                                        <span class="detail-value ${statusClass}">
                                            ${scorePercentage}% (${status})
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            ${categoryScoresHtml}
                            
                            <div class="detail-section">
                                <h4>Deƒüerlendirme Notlarƒ±</h4>
                                <div class="notes-section">
                                    <div id="notesDisplay" class="notes-detail">
                                        ${evaluation.evaluation_notes || 'Not bulunmuyor'}
                                    </div>
                                    <textarea id="notesEditor" class="notes-editor" style="display: none;" placeholder="Deƒüerlendirme notlarƒ±nƒ±zƒ± yazƒ±n...">${evaluation.evaluation_notes || ''}</textarea>
                                    <div class="notes-actions">
                                        <button id="editNotesBtn" class="btn-secondary" onclick="toggleNotesEdit()">
                                            <i class="fa-solid fa-edit"></i> D√ºzenle
                                        </button>
                                        <button id="saveNotesBtn" class="btn-primary" style="display: none;" onclick="saveNotes('${evaluation.analysis_id}')">
                                            <i class="fa-solid fa-save"></i> Kaydet
                                        </button>
                                        <button id="cancelNotesBtn" class="btn-secondary" style="display: none;" onclick="cancelNotesEdit()">
                                            <i class="fa-solid fa-times"></i> ƒ∞ptal
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <div class="evaluation-actions">
                                    <button class="btn-danger" onclick="deleteEvaluation('${evaluation.analysis_id}')">
                                        <i class="fa-solid fa-trash"></i> Deƒüerlendirmeyi Sil
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeEvaluationModal() {
            const modal = document.getElementById('evaluationModal');
            if (modal) {
                modal.remove();
            }
        }

        // Notes editing functions
        function toggleNotesEdit() {
            const notesDisplay = document.getElementById('notesDisplay');
            const notesEditor = document.getElementById('notesEditor');
            const editBtn = document.getElementById('editNotesBtn');
            const saveBtn = document.getElementById('saveNotesBtn');
            const cancelBtn = document.getElementById('cancelNotesBtn');

            notesDisplay.style.display = 'none';
            notesEditor.style.display = 'block';
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-flex';
            cancelBtn.style.display = 'inline-flex';
            
            notesEditor.focus();
        }

        function cancelNotesEdit() {
            const notesDisplay = document.getElementById('notesDisplay');
            const notesEditor = document.getElementById('notesEditor');
            const editBtn = document.getElementById('editNotesBtn');
            const saveBtn = document.getElementById('saveNotesBtn');
            const cancelBtn = document.getElementById('cancelNotesBtn');

            notesDisplay.style.display = 'block';
            notesEditor.style.display = 'none';
            editBtn.style.display = 'inline-flex';
            saveBtn.style.display = 'none';
            cancelBtn.style.display = 'none';
        }

        async function saveNotes(analysisId) {
            const notesEditor = document.getElementById('notesEditor');
            const newNotes = notesEditor.value;

            try {
                const response = await fetch('/api/update-evaluation-notes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        analysis_id: analysisId,
                        evaluation_notes: newNotes
                    })
                });

                if (response.ok) {
                    const notesDisplay = document.getElementById('notesDisplay');
                    notesDisplay.textContent = newNotes || 'Not bulunmuyor';
                    cancelNotesEdit();
                    
                    // Refresh evaluations list
                    loadEvaluations();
                    
                    alert('Notlar ba≈üarƒ±yla g√ºncellendi!');
                } else {
                    throw new Error('G√ºncelleme ba≈üarƒ±sƒ±z');
                }
            } catch (error) {
                console.error('Notes update error:', error);
                alert('Notlar g√ºncellenirken hata olu≈ütu: ' + error.message);
            }
        }

        async function deleteEvaluation(analysisId) {
            if (!confirm('Bu deƒüerlendirmeyi silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.')) {
                return;
            }

            try {
                const response = await fetch('/api/delete-evaluation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        analysis_id: analysisId
                    })
                });

                if (response.ok) {
                    closeEvaluationModal();
                    loadEvaluations();
                    alert('Deƒüerlendirme ba≈üarƒ±yla silindi!');
                } else {
                    throw new Error('Silme i≈ülemi ba≈üarƒ±sƒ±z');
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Deƒüerlendirme silinirken hata olu≈ütu: ' + error.message);
            }
        }

        // Tema toggle
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light');
            if(document.body.classList.contains('light')) {
                themeToggle.innerHTML = '<i class="fa-solid fa-sun"></i><span>A√ßƒ±k</span>';
            } else {
                themeToggle.innerHTML = '<i class="fa-solid fa-moon"></i><span>Koyu</span>';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadDocumentTypes();
        });
    </script>
    <!-- Add Document Type Modal -->
    <div id="addDocTypeModal" class="modal-overlay" style="display:none;" onclick="closeAddDocTypeModal(event)">
        <div class="modal-content modal-large" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="fa-solid fa-plus-circle"></i> Yeni D√∂k√ºman T√ºr√º Ekle</h3>
                <button onclick="closeAddDocTypeModal()" class="modal-close">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addDocTypeForm">
                    <!-- Temel Bilgiler -->
                    <div class="form-section">
                        <h4><i class="fa-solid fa-info-circle"></i> Temel Bilgiler</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>D√∂k√ºman T√ºr√º Adƒ± *</label>
                                <input type="text" id="docTypeName" placeholder="√ñrn: Yangƒ±n S√∂nd√ºrme Raporu" required />
                            </div>
                            <div class="form-group">
                                <label>Icon *</label>
                                <select id="docTypeIcon" required>
                                    <option value="">Se√ßiniz</option>
                                    <option value="üî•">üî•</option>
                                    <option value="üíß">üíß</option>
                                    <option value="‚ö°">‚ö°</option>
                                    <option value="üîß">üîß</option>
                                    <option value="üîä">üîä</option>
                                    <option value="üí°">üí°</option>
                                    <option value="üìã">üìã</option>
                                    <option value="üîí">üîí</option>
                                    <option value="ü§ñ">ü§ñ</option>
                                    <option value="üìÑ">üìÑ</option>
                                    <option value="üîç">üîç</option>
                                    <option value="‚úÖ">‚úÖ</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>A√ßƒ±klama (Opsiyonel)</label>
                            <input type="text" id="docTypeDescription" placeholder="Kƒ±sa a√ßƒ±klama..." />
                        </div>
                        <div class="form-group">
                            <label style="display:flex; align-items:center; gap:0.5rem;">
                                <input type="checkbox" id="docTypeOCR" style="width:auto;" />
                                OCR Kullan
                            </label>
                        </div>
                    </div>

                    <!-- Kategoriler ve Puanlar -->
                    <div class="form-section">
                        <h4><i class="fa-solid fa-list"></i> Kategoriler ve Puanlar</h4>
                        <div id="categoriesContainer">
                            <!-- Dynamic categories here -->
                        </div>
                        <button type="button" class="btn-add-item" onclick="addCategory()">
                            <i class="fa-solid fa-plus"></i> Kategori Ekle
                        </button>
                    </div>

                    <!-- Extract Values -->
                    <div class="form-section">
                        <h4><i class="fa-solid fa-search"></i> √áƒ±karƒ±lacak Bilgiler</h4>
                        <p class="form-help">Rapordan √ßƒ±karmak istediƒüiniz bilgileri yazƒ±n (√ñrn: rapor no, firma adƒ±, tarih), virg√ºl ile ayƒ±rƒ±n</p>
                        <div id="extractValuesContainer">
                            <!-- Dynamic extract values here -->
                        </div>
                        <button type="button" class="btn-add-item" onclick="addExtractValue()">
                            <i class="fa-solid fa-plus"></i> Alan Ekle
                        </button>
                    </div>

                    <!-- Strong Keywords -->
                    <div class="form-section">
                        <h4><i class="fa-solid fa-key"></i> √ñzg√º Kelimeler (Minimum 1)</h4>
                        <p class="form-help">Bu rapora √∂zg√º kelimeleri yazƒ±n, virg√ºl ile ayƒ±rƒ±n</p>
                        <textarea id="strongKeywords" rows="3" placeholder="yangƒ±n, s√∂nd√ºrme, fire, extinguisher"></textarea>
                    </div>

                    <!-- Actions -->
                    <div class="form-actions">
                        <button type="button" class="btn-outline" onclick="closeAddDocTypeModal()">
                            <i class="fa-solid fa-times"></i> ƒ∞ptal
                        </button>
                        <button type="submit" class="btn-primary">
                            <i class="fa-solid fa-save"></i> Kaydet
                        </button>
                    </div>

                    <!-- Loading -->
                    <div id="docTypeLoading" class="loading" style="display:none;">
                        <div class="spinner"></div>
                        <h3 style="font-size:.9rem;">AI Pattern'leri Olu≈üturuyor...</h3>
                        <p style="font-size:.65rem; color:var(--text-dim);">Bu i≈ülem 1 dakika s√ºrebilir</p>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Manage Dynamic Types Modal -->
    <div id="manageDynamicModal" class="modal-overlay" style="display:none;" onclick="closeManageDynamicModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="fa-solid fa-cog"></i> Yeni D√∂k√ºman T√ºrleri</h3>
                <button onclick="closeManageDynamicModal()" class="modal-close">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="dynamicTypesList" style="display: grid; gap: 1rem;">
                    <!-- Dynamic types buraya y√ºklenecek -->
                </div>
            </div>
        </div>
    </div>
    <script>
    // =====================================================
    // D√ñK√úMAN T√úR√ú EKLEME MODAL FONKSƒ∞YONLARI
    // =====================================================

    let categoryCounter = 0;
    let keywordCounter = 0;
    let extractCounter = 0;

    // Modal A√ß
    function openAddDocTypeModal() {
        document.getElementById('addDocTypeModal').style.display = 'flex';
        // ƒ∞lk kategori otomatik ekle
        if (categoryCounter === 0) {
            addCategory();
        }
    }

        // Modal Kapat
    function closeAddDocTypeModal(event) {
        // event undefined olabilir (X butonundan √ßaƒürƒ±lƒ±rsa)
        if (!event || event.target.id === 'addDocTypeModal' || event.target.closest('.modal-close')) {
            document.getElementById('addDocTypeModal').style.display = 'none';
            // Formu resetle
            document.getElementById('addDocTypeForm').reset();
            document.getElementById('categoriesContainer').innerHTML = '';
            document.getElementById('extractValuesContainer').innerHTML = '';
            categoryCounter = 0;
            keywordCounter = 0;
            extractCounter = 0;
            // Loading gizle
            document.getElementById('docTypeLoading').style.display = 'none';
        }
    }

    // Kategori Ekle
    function addCategory() {
        categoryCounter++;
        const container = document.getElementById('categoriesContainer');
        
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category-item';
        categoryDiv.id = `category-${categoryCounter}`;
        categoryDiv.setAttribute('data-category-id', categoryCounter);
        
        categoryDiv.innerHTML = `
            <div style="display: flex; gap: 0.8rem; align-items: flex-start; margin-bottom: 0.8rem;">
                <div style="flex: 1;">
                    <label>Kategori Adƒ±</label>
                    <input type="text" class="category-name" placeholder="√ñrn: Genel Bilgiler" required>
                </div>
                <div style="flex: 0 0 120px;">
                    <label>Puan Aƒüƒ±rlƒ±ƒüƒ±</label>
                    <input type="number" class="category-weight" min="1" max="100" placeholder="%" required>
                </div>
                <button type="button" class="btn-remove" onclick="removeCategory(${categoryCounter})" style="margin-top: 1.8rem;">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            <div style="margin-left: 1.5rem; border-left: 2px solid var(--border-color); padding-left: 1rem;">
                <div class="keywords-container" id="keywords-${categoryCounter}">
                    <!-- Anahtar kelimeler buraya eklenecek -->
                </div>
                <button type="button" class="btn-add-item" onclick="addKeyword(${categoryCounter})">
                    <i class="fa-solid fa-plus"></i> Anahtar Kelime Ekle
                </button>
            </div>
        `;
        
        container.appendChild(categoryDiv);
        // ƒ∞lk keyword otomatik ekle
        addKeyword(categoryCounter);
    }

    // Kategori Sil
    function removeCategory(categoryId) {
        const categoryDiv = document.getElementById(`category-${categoryId}`);
        if (categoryDiv) {
            categoryDiv.remove();
        }
    }

    // Anahtar Kelime Ekle
    function addKeyword(categoryId) {
        keywordCounter++;
        const container = document.getElementById(`keywords-${categoryId}`);
        
        const keywordDiv = document.createElement('div');
        keywordDiv.className = 'keyword-item';
        keywordDiv.id = `keyword-${keywordCounter}`;
        keywordDiv.style.cssText = 'display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;';
        
        keywordDiv.innerHTML = `
            <input type="text" class="keyword-input" placeholder="√ñrn: firma adƒ±" style="flex: 1;" required>
            <button type="button" class="btn-remove" onclick="removeKeyword(${keywordCounter})" style="padding: 0.4rem 0.6rem;">
                <i class="fa-solid fa-times"></i>
            </button>
        `;
        
        container.appendChild(keywordDiv);
    }

    // Anahtar Kelime Sil
    function removeKeyword(keywordId) {
        const keywordDiv = document.getElementById(`keyword-${keywordId}`);
        if (keywordDiv) {
            keywordDiv.remove();
        }
    }

    // √áƒ±karƒ±lacak Bilgi Ekle
    function addExtractValue() {
        extractCounter++;
        const container = document.getElementById('extractValuesContainer');
        
        const extractDiv = document.createElement('div');
        extractDiv.className = 'extract-item';
        extractDiv.id = `extract-${extractCounter}`;
        extractDiv.style.cssText = 'display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;';
        
        extractDiv.innerHTML = `
            <input type="text" class="extract-input" placeholder="√ñrn: test_tarihi" style="flex: 1;" required>
            <button type="button" class="btn-remove" onclick="removeExtractValue(${extractCounter})" style="padding: 0.4rem 0.6rem;">
                <i class="fa-solid fa-times"></i>
            </button>
        `;
        
        container.appendChild(extractDiv);
    }

    // √áƒ±karƒ±lacak Bilgi Sil
    function removeExtractValue(extractId) {
        const extractDiv = document.getElementById(`extract-${extractId}`);
        if (extractDiv) {
            extractDiv.remove();
        }
    }

    // Form Submit
    document.getElementById('addDocTypeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Loading g√∂ster
        const loadingDiv = document.getElementById('docTypeLoading');
        loadingDiv.style.display = 'flex';
        
        try {
            // Form verilerini topla
            const formData = {
                name: document.getElementById('docTypeName').value.trim(),
                icon: document.getElementById('docTypeIcon').value,
                description: document.getElementById('docTypeDescription').value.trim(),
                needs_ocr: document.getElementById('docTypeOCR').checked,
                categories: [],
                extract_values: [],
                strong_keywords: []
            };
            
            // Kategorileri topla (BACKEND FORMAT)
            formData.criteria_weights = {};
            formData.criteria_details = {};

            const categories = document.querySelectorAll('.category-item');
            categories.forEach(catDiv => {
                const categoryName = catDiv.querySelector('.category-name').value.trim();
                const categoryWeight = parseInt(catDiv.querySelector('.category-weight').value);
                const keywords = [];
                
                catDiv.querySelectorAll('.keyword-input').forEach(input => {
                    const keyword = input.value.trim();
                    if (keyword) keywords.push(keyword);
                });
                
                if (categoryName && categoryWeight && keywords.length > 0) {
                    // Backend'in beklediƒüi format
                    formData.criteria_weights[categoryName] = categoryWeight;
                    formData.criteria_details[categoryName] = keywords;
                }
            });

            // Eski array'i sil
            delete formData.categories;
            
            // √áƒ±karƒ±lacak bilgileri topla
            document.querySelectorAll('.extract-input').forEach(input => {
                const value = input.value.trim();
                if (value) formData.extract_values.push(value);
            });
            
            // √ñzg√º kelimeleri topla (virg√ºlle ayrƒ±lmƒ±≈ü)
            const strongKeywordsText = document.getElementById('strongKeywords').value.trim();
            if (strongKeywordsText) {
                formData.strong_keywords = strongKeywordsText.split(',').map(k => k.trim()).filter(k => k);
            }
            
            // Validasyon
            if (Object.keys(formData.criteria_weights).length === 0) {
                alert('En az bir kategori eklemelisiniz!');
                loadingDiv.style.display = 'none';
                return;
            }
            
            if (formData.strong_keywords.length === 0) {
                alert('En az bir √∂zg√º kelime girmelisiniz!');
                loadingDiv.style.display = 'none';
                return;
            }
            
            // API'ye g√∂nder
            const response = await fetch('/api/create-dynamic-type', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`‚úÖ ${result.message}\n\nD√∂k√ºman Kodu: ${result.code}`);
                
                // Dropdown'ƒ± yenile
                await loadDocumentTypes();
                
                // Modal'ƒ± kapat
                closeAddDocTypeModal({ target: { id: 'addDocTypeModal' } });
            } else {
                alert(`‚ùå Hata: ${result.error}`);
            }
            
        } catch (error) {
            console.error('Form g√∂nderim hatasƒ±:', error);
            alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
        } finally {
            loadingDiv.style.display = 'none';
        }
    });

    // D√∂k√ºman t√ºrlerini y√ºkle (dropdown g√ºncellemesi i√ßin)
    async function loadDocumentTypes() {
        try {
            const response = await fetch('/api/document-types');
            const data = await response.json();  // üëà data objesi
            
            if (data.success && data.document_types) {  // üëà data.document_types array'i
                const select = document.getElementById('documentType');
                const currentValue = select.value;
                
                // Mevcut option'larƒ± temizle (ilk "se√ßiniz" hari√ß)
                while (select.options.length > 1) {
                    select.remove(1);
                }
                
                // Yeni option'larƒ± ekle
                data.document_types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type.code;
                    
                    // Dynamic service mi kontrol et
                    const isDynamic = type.endpoint === '/api/dynamic-report';
                    
                    if (isDynamic) {
                        option.textContent = `${type.icon || 'üìÑ'} ${type.name} [üóëÔ∏è]`;  // Sil ikonu ekle
                        option.setAttribute('data-dynamic', 'true');
                        option.setAttribute('data-code', type.code);
                    } else {
                        option.textContent = `${type.icon || 'üìÑ'} ${type.name}`;
                    }
                    
                    select.appendChild(option);
                });
                
                // √ñnceki se√ßimi koru (varsa)
                if (currentValue) {
                    select.value = currentValue;
                }
                
                console.log('‚úÖ Document types y√ºklendi:', data.document_types.length);
            }
            
        } catch (error) {
            console.error('‚ùå D√∂k√ºman t√ºrleri y√ºklenemedi:', error);
        }
    }

    // Sayfa y√ºklendiƒüinde d√∂k√ºman t√ºrlerini y√ºkle
    document.addEventListener('DOMContentLoaded', loadDocumentTypes);

    // Dynamic Types Y√∂netimi
    async function openManageDynamicTypesModal() {
        document.getElementById('manageDynamicModal').style.display = 'flex';
        await loadDynamicTypesList();
    }

    function closeManageDynamicModal(event) {
        if (!event || event.target.id === 'manageDynamicModal' || event.target.closest('.modal-close')) {
            document.getElementById('manageDynamicModal').style.display = 'none';
        }
    }

    async function loadDynamicTypesList() {
        try {
            const response = await fetch('/api/document-types');
            const data = await response.json();
            
            if (!data.success) {
                throw new Error('D√∂k√ºman t√ºrleri y√ºklenemedi');
            }
            
            // Sadece dynamic olanlarƒ± filtrele
            const dynamicTypes = data.document_types.filter(type => 
                type.endpoint === '/api/dynamic-report'
            );
            
            const listDiv = document.getElementById('dynamicTypesList');
            
            if (dynamicTypes.length === 0) {
                listDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-dim);">
                        <i class="fa-solid fa-inbox" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <p>Hen√ºz yeni d√∂k√ºman t√ºr√º yok</p>
                    </div>
                `;
                return;
            }
            
            listDiv.innerHTML = dynamicTypes.map(type => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 2rem;">${type.icon || 'üìÑ'}</span>
                        <div>
                            <div style="font-weight: 600;">${type.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-dim);">Code: ${type.code}</div>
                        </div>
                    </div>
                    <button class="btn-danger" onclick="deleteDynamicType('${type.code}', '${type.name}')" style="padding: 0.5rem 1rem;">
                        <i class="fa-solid fa-trash"></i> Sil
                    </button>
                </div>
            `).join('');
            
        } catch (error) {
            console.error('Dynamic types y√ºkleme hatasƒ±:', error);
            document.getElementById('dynamicTypesList').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--danger);">
                    <i class="fa-solid fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Y√ºkleme hatasƒ±: ${error.message}</p>
                </div>
            `;
        }
    }

    async function deleteDynamicType(code, name) {
        // Onay dialog'u
        const confirmed = confirm(
            `"${name}" d√∂k√ºman t√ºr√ºn√º silmek istediƒüinize emin misiniz?\n\n` +
            `‚ö†Ô∏è Bu i≈ülem geri alƒ±namaz!\n` +
            `‚ö†Ô∏è T√ºm ili≈ükili veriler (kategoriler, pattern'ler, vb.) silinecek!`
        );
        
        if (!confirmed) return;
        
        try {
            const response = await fetch('/api/delete-dynamic-type', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`‚úÖ ${name} ba≈üarƒ±yla silindi!`);
                
                // Listeyi yenile
                await loadDynamicTypesList();
                
                // Dropdown'ƒ± yenile
                await loadDocumentTypes();
            } else {
                alert(`‚ùå Silme hatasƒ±: ${result.message}`);
            }
            
        } catch (error) {
            console.error('Silme hatasƒ±:', error);
            alert('Bir hata olu≈ütu. L√ºtfen tekrar deneyin.');
        }
    }

    </script>
</body>
</html>
